var sdpUtils=new SdpUtils;function extractVersion(e,i,t){var a=e.match(i);return a&&a.length>=t&&parseInt(a[t],10)}function detectBrowser(e){var i=e.navigator,t={browser:null,version:null};if(void 0===e||!e.navigator)return t.browser="Not a browser.",t;if(i.mozGetUserMedia)t.browser="firefox",t.version=extractVersion(i.userAgent,/Firefox\/(\d+)\./,1);else if(i.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection&&!e.RTCIceGatherer)t.browser="chrome",t.version=extractVersion(i.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(i.mediaDevices&&i.userAgent.match(/Edge\/(\d+).(\d+)$/))t.browser="edge",t.version=extractVersion(i.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!e.RTCPeerConnection||!i.userAgent.match(/AppleWebKit\/(\d+)\./))return t.browser="Not a supported browser.",t;t.browser="safari",t.version=extractVersion(i.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype}return t}function ICEInfo(){this.iceUfrag="",this.icePwd="",this.iceOptions="",this.iceLite=!1}function FingerprintInfo(){this.algorithm="",this.value=""}function CodecInfo(){this.payload=0,this.codecName="",this.codecInterval="",this.rtcpFB=[],this.fmtp=[]}function SSRCInfo(){this.ssrc=0,this.cname="",this.mslabel="",this.label="",this.msid=""}function MediaDesc(){this.type="",this.protocol="UDP/TLS/RTP/SAVPF",this.iceInfo=new ICEInfo,this.fingerprintInfo=new FingerprintInfo,this.setup="",this.mid="",this.msid="",this.extmap={},this.commAbility="sendrecv",this.rtcpMux=!0,this.rtcpResize=!1,this.codecInfoMap={},this.codecInfoArray=[],this.ssrcInfoMap={},this.ssrcInfoArray=[],this.ssrcGroup=[],this.candidate=[]}function SdpDesc(){this.version=0,this.username="-",this.sessionID=0,this.sessionVersion=0,this.sessionName="-",this.sessionStartTime=0,this.sessionEndTime=0,this.iceInfo=new ICEInfo,this.fingerprintInfo=new FingerprintInfo,this.group=[],this.wms=[],this.mediaDesc=[]}function SdpUtils(){SdpUtils.prototype.clone=function e(i){if(null==i||"object"!=typeof i)return i;if(i instanceof Date)return(t=new Date).setTime(i.getTime()),t;if(i instanceof Array){for(var t=[],a=i.length,r=0;r<a;++r)t[r]=e(i[r]);return t}if(i instanceof Object){t={};for(var n in i)i.hasOwnProperty(n)&&(t[n]=e(i[n]));return t}throw new Error("Unable to copy obj! Its type isn't supported.")},SdpUtils.prototype.parseSdp=function(e){var i=new SdpDesc,t=e.split("\r\n"),a=!1,r=null;for(var n in t){switch(t[n].charAt(0)){case"v":i.version=parseInt(t[n].substring(2));break;case"o":var s=t[n].substring(2).split(" ");i.username=s[0],i.sessionID=s[1],i.sessionVersion=s[2];break;case"s":i.sessionName=t[n].substring(2);break;case"t":s=t[n].substring(2).split(" ");i.sessionStartTime=parseInt(s[0]),i.sessionEndTime=parseInt(s[1]);break;case"m":null!=r&&(i.mediaDesc.push(r),r=null);s=t[n].substring(2).split(" ");(r=new MediaDesc).type=s[0],r.protocol=s[2];for(n=3;n<s.length;++n){(o=new CodecInfo).payload=parseInt(s[n]),r.codecInfoMap[o.payload]=o,r.codecInfoArray.push(o)}a=!0;break;case"a":if(a){if(-1!=t[n].indexOf("a=ice-ufrag:"))r.iceInfo.iceUfrag=t[n].substring(12);else if(-1!=t[n].indexOf("a=ice-pwd:"))r.iceInfo.icePwd=t[n].substring(10);else if(-1!=t[n].indexOf("a=ice-options:"))r.iceInfo.iceOptions=t[n].substring(14);else if(-1!=t[n].indexOf("a=ice-lite"))r.iceInfo.iceLite=!0;else if(-1!=t[n].indexOf("a=fingerprint:")){s=t[n].substring(14).split(" ");r.fingerprintInfo.algorithm=s[0],r.fingerprintInfo.value=s[1]}else if(-1!=t[n].indexOf("a=setup:"))r.setup=t[n].substring(8);else if(-1!=t[n].indexOf("a=mid:"))r.mid=t[n].substring(6);else if(-1!=t[n].indexOf("a=extmap:")){s=t[n].substring(9).split(" ");r.extmap[s[0]]=s[1]}else if(-1!=t[n].indexOf("a=rtcp-mux"))r.rtcpMux=!0;else if(-1!=t[n].indexOf("a=rtcp-rsize"))r.rtcpResize=!0;else if(-1!=t[n].indexOf("a=sendrecv")||-1!=t[n].indexOf("a=sendonly")||-1!=t[n].indexOf("a=recvonly")||-1!=t[n].indexOf("a=inactive"))r.commAbility=t[n].substring(2);else if(-1!=t[n].indexOf("a=rtpmap:")){s=t[n].substring(9).split(" ");var o=r.codecInfoMap[s[0]],c=s[1].indexOf("/");s[1].split("/");o.codecName=s[1].substring(0,c),o.codecInterval=s[1].substring(c+1)}else if(-1!=t[n].indexOf("a=rtcp-fb:")){c=t[n].indexOf(" ");var d=t[n].substring(10,c);s=t[n].substring(c+1);(o=r.codecInfoMap[d]).rtcpFB.push(s)}else if(-1!=t[n].indexOf("a=fmtp:")){s=t[n].substring(7).split(" ");(o=r.codecInfoMap[s[0]]).fmtp.push(s[1])}else if(-1!=t[n].indexOf("a=msid:")){var l=t[n].substring(7);r.msid=l}else if(-1!=t[n].indexOf("a=ssrc:")){c=t[n].indexOf(" ");var f=t[n].substring(7,c),p=(s=t[n].substring(c+1).split(":"),r.ssrcInfoMap[f]);p||((p=new SSRCInfo).ssrc=f,r.ssrcInfoArray.push(p)),"cname"==s[0]?p.cname=s[1]:"msid"==s[0]?p.msid=s[1]:"mslabel"==s[0]?p.mslabel=s[1]:"label"==s[0]&&(p.label=s[1]),r.ssrcInfoMap[f]=p}else if(-1!=t[n].indexOf("a=ssrc-group:")){s=t[n].substring(13).split(" ");for(var n in s)r.ssrcGroup.push(s[n])}else if(-1!=t[n].indexOf("a=candidate:")){s=t[n].substring(12);r.candidate.push(s)}}else if(-1!=t[n].indexOf("group:BUNDLE")){var s=t[n].split(" ");for(n=1;n<s.length;++n)i.group.push(s[n])}else if(-1!=t[n].indexOf("msid-semantic:")){var s=t[n].split(" ");i.wms.push(s[s.length-1])}else if(-1!=t[n].indexOf("a=ice-ufrag:"))i.iceInfo.iceUfrag=t[n].substring(12);else if(-1!=t[n].indexOf("a=ice-pwd:"))i.iceInfo.icePwd=t[n].substring(10);else if(-1!=t[n].indexOf("a=ice-options:"))i.iceInfo.iceOptions=t[n].substring(14);else if(-1!=t[n].indexOf("a=ice-lite"))i.iceInfo.iceLite=!0;else if(-1!=t[n].indexOf("a=fingerprint:")){var s=t[n].substring(14).split(" ");i.fingerprintInfo.algorithm=s[0],i.fingerprintInfo.value=s[1]}}}return null!=r&&(i.mediaDesc.push(r),r=null),i},SdpUtils.prototype.genIceInfoSdp=function(e){var i="";return""!=e.iceUfrag&&(i+="a=ice-ufrag:"+e.iceUfrag+"\r\n"),""!=e.icePwd&&(i+="a=ice-pwd:"+e.icePwd+"\r\n"),e.iceLite?i+="a=ice-lite\r\n":""!=e.iceOptions&&(i+="a=ice-options:"+e.iceOptions+"\r\n"),i},SdpUtils.prototype.genFingerprintSdp=function(e){var i="";return""!=e.algorithm&&(i+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"),i},SdpUtils.prototype.genCodecSdp=function(e){var i="";for(var t in i+="a=rtpmap:"+e.payload+" "+e.codecName+"/"+e.codecInterval+"\r\n",e.rtcpFB)i+="a=rtcp-fb:"+e.payload+" "+e.rtcpFB[t]+"\r\n";for(var t in e.fmtp)i+="a=fmtp:"+e.payload+" "+e.fmtp[t]+"\r\n";return i},SdpUtils.prototype.genSSRCSdp=function(e){var i="";return e.cname&&(i+="a=ssrc:"+e.ssrc+" cname:"+e.cname+"\r\n"),e.msid&&(i+="a=ssrc:"+e.ssrc+" msid:"+e.msid+"\r\n"),e.mslabel&&(i+="a=ssrc:"+e.ssrc+" mslabel:"+e.mslabel+"\r\n"),e.label&&(i+="a=ssrc:"+e.ssrc+" label:"+e.label+"\r\n"),i},SdpUtils.prototype.genMediaSdp=function(e){var i="";i+="m="+e.type+" 9 "+e.protocol;var t="";for(var a in e.codecInfoArray){var r=e.codecInfoArray[a];i+=" "+r.payload,t+=this.genCodecSdp(r)}for(var a in i+="\r\n",i+="c=IN IP4 0.0.0.0\r\n",e.candidate)i+="a=candidate:"+e.candidate[a]+"\r\n";for(var n in 0<e.candidate.length&&(i+="a=end-of-candidates\r\n"),i+="a="+e.commAbility+"\r\n",i+="a=setup:"+e.setup+"\r\n",i+="a=mid:"+e.mid+"\r\n",e.msid&&(i+="a=msid:"+e.msid+"\r\n"),i+=this.genIceInfoSdp(e.iceInfo),i+=this.genFingerprintSdp(e.fingerprintInfo),1==e.rtcpMux&&(i+="a=rtcp-mux\r\n"),1==e.rtcpResize&&(i+="a=rtcp-rsize\r\n"),e.extmap)i+="a=extmap:"+n+" "+e.extmap[n]+"\r\n";for(var a in i+=t,e.ssrcGroup.length&&(i+="a=ssrc-group:FID "+e.ssrcGroup.join(" ")+"\r\n"),e.ssrcInfoArray)i+=this.genSSRCSdp(e.ssrcInfoArray[a]);return i},SdpUtils.prototype.genSdp=function(e){var i="";i+="v="+e.version+"\r\n",i+="o="+e.username+" "+e.sessionID+" "+e.sessionVersion+" IN IP4 127.0.0.1\r\n",i+="s="+e.sessionName+"\r\n",i+="t="+e.sessionStartTime+" "+e.sessionEndTime+"\r\n";var t="",a="";for(var r in e.mediaDesc)a+=" "+e.mediaDesc[r].mid,t+=this.genMediaSdp(e.mediaDesc[r]);return""!=a&&(i+="a=group:BUNDLE"+a+"\r\n"),0!=e.wms.length&&(i+="a=msid-semantic:WMS *\r\n"),i+=this.genIceInfoSdp(e.iceInfo),i+=this.genFingerprintSdp(e.fingerprintInfo),i+=t}}var StarWebRTC=function(e){var n=RTCPeerConnection,r=(navigator.mediaDevices.getUserMedia,RTCIceCandidate,RTCSessionDescription),s=detectBrowser(window),m=e||{iceServers:[],iceTransportPolicy:"all",bundlePolicy:"balanced",rtcpMuxPolicy:"require",iceCandidatePoolSize:0};null==m.sdpSemantics&&(m.sdpSemantics="unified-plan","chrome"==s.browser?s.version<72&&(m.sdpSemantics="plan-b"):"safari"==s.browser&&(s.supportsUnifiedPlan||(m.sdpSemantics="plan-b"))),null==m.iceControlRole&&(m.iceControlRole="controlled","firefox"==s.browser&&(m.iceControlRole="controlling"));function i(){this.events={}}function t(){this.localMediaStream=null,this.room="",this.fileData={},this.socket=null,this.me=null,this.peerConnections={},this.connections=[],this.numStreams=0,this.initializedStreams=0,this.dataChannels={},this.fileChannels={},this.receiveFiles={},this.localSmallMediaStream=null,this.localSmallMediaTrack=null,this.bigStreamId="",this.smallStreamId="",this.audioStreamId="",this.answerSDP="",this.offerSDP=null,this.starPeerConnection=null,this.tempPC=null,this.callback=null,this.streamAllSetCallback=null,this.serverIp="0.0.0.0",this.serverPort=80,this.streamInfos=[]}function a(){this.videoId="",this.streamId="",this.bigVideoSSRC=0,this.smallVideoSSRC=0,this.audioSSRC=0,this.streamObj=null,this.switchFlag=!1}i.prototype.on=function(e,i){this.events[e]=this.events[e]||[],this.events[e].push(i)},i.prototype.emit=function(e,i){var t,a,r=this.events[e],n=Array.prototype.slice.call(arguments,1);if(r)for(t=0,a=r.length;t<a;t++)r[t].apply(null,n)},(t.prototype=new i).destroy=function(){this.emit("_remove_peer")},t.prototype.resetStreamInfos=function(e){this.streamInfos=[];for(var i=0;i<7;++i){var t=new a;t.bigVideoSSRC=2312312300+i,t.smallVideoSSRC=2312311300+i,t.audioSSRC=2312310300+i,t.streamId=this.createRandomString(u,36),t.cname=this.createRandomString(u,16),this.streamInfos.push(t)}},t.prototype.init=function(){this.resetStreamInfos();var p=this;this.on("_peers",function(e){p.connections=e.connections,p.me=e.you,p.emit("get_peers",p.connections)}),this.on("_remove_peer",function(e){p.starPeerConnection&&(p.closePeerConnection(p.starPeerConnection),delete p.starPeerConnection,p.starPeerConnection=null),p.tempPC&&(p.closePeerConnection(p.tempPC),delete p.tempPC,p.tempPC=null),null!=p.localMediaStream&&(p.localMediaStream.getTracks().forEach(function(e){e.stop()}),p.localMediaStream=null),null!=p.localSmallMediaTrack&&(p.localSmallMediaTrack.stop(),p.localSmallMediaTrack=null),null!=p.localSmallMediaStream&&(p.localSmallMediaStream.getTracks().forEach(function(e){e.stop()}),p.localSmallMediaStream=null),p.bigStreamId="",p.smallStreamId="",p.audioStreamId="",p.answerSDP="",p.offerSDP=null,p.callback=null,p.serverIp="0.0.0.0",p.serverPort=80,p.resetStreamInfos()}),this.on("_offer",function(e){p.receiveOffer(e.socketId,e.sdp),p.emit("get_offer",e)}),this.on("_answer",function(e){var i=e.sessionDesc;i.type="answer",i.sdp=i.sdp.replace(/actpass/g,"active"),p.receiveAnswer(e.socketId,i),p.emit("get_answer",e)}),this.on("_webrtc_apply_ok",function(e,i,t,a){if(null==p.offerSDP)p.offerSDP=p.createDefaultSdpObj(t,a);else{var r=!1,n=!1;for(var s in p.offerSDP.mediaDesc){var o=p.offerSDP.mediaDesc[s];"audio"==o.type?n=!0:"video"==o.type&&(r=!0)}n||p.offerSDP.mediaDesc.push(p.createDefaultAudioMediaSdpObj(a)),r||p.offerSDP.mediaDesc.push(p.createDefaultVideoMediaSdpObj(t))}p.streamAllSetCallback=i;var c="504457478 1 udp 2013266431 "+p.serverIp+" "+p.serverPort+" typ host generation 0 ufrag Nud3 network-id 1",d=sdpUtils.clone(p.offerSDP);"controlled"==m.iceControlRole?"plan-b"==m.sdpSemantics?p.createAnswerFromOfferPlanB(d,"Nud3","SKuOCnwS3ScdasO5hD2aheqb",e,p.streamInfos,[c]):p.createAnswerFromOfferUnifyPlan(d,"Nud3","SKuOCnwS3ScdasO5hD2aheqb",e,p.streamInfos,[c]):"plan-b"==m.sdpSemantics?p.createAnswerFromOfferPlanB(d,"Nud3","SKuOCnwS3ScdasO5hD2aheqb",e,p.streamInfos,[c]):p.createAnswerFromOfferUnifyPlan2(d,"Nud3","SKuOCnwS3ScdasO5hD2aheqb",e,p.streamInfos,[c]);var l=sdpUtils.genSdp(d),f={};"controlled"==m.iceControlRole?f.type="offer":f.type="answer",f.sdp=l,p.starPeerConnection.setRemoteDescription(f).then(function(){"controlled"==m.iceControlRole?p.starPeerConnection.createAnswer(function(e){var i=sdpUtils.parseSdp(e.sdp);p.filterSdpObj(i),p.replaceData(i);var t=sdpUtils.genSdp(i);e.sdp=t,p.starPeerConnection.setLocalDescription(e).then(function(){p.callback({type:"applyAnswer",status:"success"})},function(e){console.error(e),p.callback({type:"applyAnswer",status:"failed"})})},function(e){console.error(e),p.callback({type:"applyAnswer",status:"failed"})}):p.callback({type:"applyAnswer",status:"success"})},function(e){console.error(e),p.callback({type:"applyAnswer",status:"failed"})})}),this.on("ready",function(e,i){var t=i||!1;p.callback=e,p.createPeerConnections(),p.addStreams(t),p.sendOffers()})},t.prototype.createScreenCaptureStream=function(e,i,t){var a=this;(function(e){return navigator.getDisplayMedia?navigator.getDisplayMedia({video:!0,audio:e.audio}):navigator.mediaDevices.getDisplayMedia?navigator.mediaDevices.getDisplayMedia({video:!0,audio:e.audio}):navigator.mediaDevices.getUserMedia({video:{mediaSource:"screen"},audio:e.audio})})(e).then(function(e){a.localMediaStream=e,a.localMediaStream&&(a.localMediaStream.addEventListener("inactive",function(e){console.warn("Capture stream inactive"),t(e)}),a.initializedStreams++),i("success",e)}).catch(function(e){i("failed",e)})},t.prototype.publishStream=function(i){this.starPeerConnection&&this.starPeerConnection.getSenders().forEach(function(e){e.track&&("video"==e.track.kind&&null!=i.video?e.track.enabled=i.video:"audio"==e.track.kind&&null!=i.audio&&(e.track.enabled=i.audio))})},t.prototype.createStream=function(n,i,t){var a=this;n.video||n.audio?navigator.mediaDevices.getUserMedia?(this.numStreams++,navigator.mediaDevices.enumerateDevices().then(function(e){for(var i=!1,t=!1,a=0;a!==e.length;++a){var r=e[a];"audioinput"===r.kind?i=!0:"audiooutput"===r.kind||("videoinput"===r.kind?t=!0:console.info("Some other kind of source/device: ",r))}return t||(n.video=!1),i||(n.audio=!1),n.video||n.audio?navigator.mediaDevices.getUserMedia(n):Promise.resolve(null)}).then(function(e){a.localMediaStream=e,a.localMediaStream&&(a.localMediaStream.addEventListener("inactive",function(e){console.warn("Capture stream inactive"),t(e)}),a.initializedStreams++),i("success",e)}).catch(function(e){i("failed",e)})):i("failed",new Error("WebRTC is not yet supported in this browser.")):i("success",null)},t.prototype.addStreams=function(t){if(null!=this.localMediaStream){var a=this,r=!1,n=null;window.RTCPeerConnection.prototype.addTrack&&65<=s.version&&(r=!0),r||t||(n=this.localMediaStream.clone()).getTracks().forEach(function(e){e.stop(),n.removeTrack(e)}),this.localMediaStream.getTracks().forEach(function(e){if(r&&(a.starPeerConnection.addTrack(e,a.localMediaStream),"controlled"==m.iceControlRole&&a.tempPC.addTrack(e,a.localMediaStream)),"video"==e.kind){if(a.bigStreamId=e.id,!t){var i=e.clone();a.localSmallMediaTrack=i,a.smallStreamId=i.id,MediaStreamTrack.prototype.applyConstraints&&("safari"!=s.browser?i.applyConstraints({width:{ideal:120},height:{ideal:90},facingMode:{ideal:["user"]}}):i.applyConstraints({width:{ideal:640},height:{ideal:480},facingMode:{ideal:["user"]}})),r?(a.starPeerConnection.addTrack(i,a.localMediaStream),"controlled"==m.iceControlRole&&a.tempPC.addTrack(i,a.localMediaStream)):n.addTrack(i)}}else"audio"==e.kind&&(a.audioStreamId=e.id)}),r||(a.starPeerConnection.addStream(a.localMediaStream),"controlled"==m.iceControlRole&&a.tempPC.addStream(a.localMediaStream),null!=n&&(a.starPeerConnection.addStream(n),"controlled"==m.iceControlRole&&a.tempPC.addStream(n))),a.localSmallMediaStream=n}},t.prototype.attachStream=function(e,i){document.getElementById(i).srcObject=e},t.prototype.switchStream=function(i){var t=[];i.getVideoTracks().forEach(function(e){t.push(e),i.removeTrack(e)});for(var e=t.length-1;0<=e;e--)i.addTrack(t[e])},t.prototype.switchStreamInfo=function(e){e.switchFlag=!e.switchFlag,this.switchStream(e.streamObj)},t.prototype.resetStreamInfo=function(e){e.switchFlag&&this.switchStreamInfo(e)},t.prototype.switchStreams=function(){for(var e in this.streamInfos)this.switchStreamInfo(this.streamInfos[e])},t.prototype.getStreamByIndex=function(e){return this.streamInfos[e]},t.prototype.getStreamInfos=function(e){return this.streamInfos},t.prototype.onAddStream=function(e){var i=!0;for(var t in this.streamInfos){var a=this.streamInfos[t];a.streamId==e.id&&(a.streamObj=e),null==a.streamObj&&(i=!1)}i&&null!=this.streamAllSetCallback&&"connected"==this.starPeerConnection.iceConnectionState&&(this.streamAllSetCallback(),this.streamAllSetCallback=null)},t.prototype.setServerInfo=function(e){this.serverIp=e.serverIp,this.serverPort=e.serverPort};var u=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9"],o=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","+","/"];return t.prototype.createRandomString=function(e,i){for(var t="",a=0;a<i;++a)t+=e[Math.floor(Math.random()*e.length)];return t},t.prototype.uuid=function(){function e(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},t.prototype.replaceData=function(e){for(var i in""==e.iceInfo.iceUfrag&&""!=this.sdpData.iceUfrag&&(e.iceInfo.iceUfrag=this.sdpData.iceUfrag,e.iceInfo.icePwd=this.sdpData.icePwd),e.mediaDesc){var t=e.mediaDesc[i];if(""!=this.sdpData.iceUfrag&&(t.iceInfo.iceUfrag=this.sdpData.iceUfrag,t.iceInfo.icePwd=this.sdpData.icePwd),"audio"==t.type){if(t.msid&&""!=t.msid){if(""!=this.audioStreamId&&-1!=t.msid.indexOf(this.audioStreamId)){a=t.ssrcInfoArray[0];delete t.ssrcInfoMap[a.ssrc],a.ssrc=this.sdpData.audioSSRC,t.ssrcInfoMap[a.ssrc]=a}}else if(""!=this.audioStreamId)for(var i in t.ssrcInfoArray){-1!=(a=t.ssrcInfoArray[i]).msid.indexOf(this.audioStreamId)&&(delete t.ssrcInfoMap[a.ssrc],a.ssrc=this.sdpData.audioSSRC,t.ssrcInfoMap[a.ssrc]=a)}}else if("video"==t.type)if(t.msid&&""!=t.msid){if(""!=this.smallStreamId&&-1!=t.msid.indexOf(this.smallStreamId)){a=t.ssrcInfoArray[0];delete t.ssrcInfoMap[a.ssrc],a.ssrc=this.sdpData.smallVideoSSRC,t.ssrcInfoMap[a.ssrc]=a}else if(""!=this.bigStreamId&&-1!=t.msid.indexOf(this.bigStreamId)){a=t.ssrcInfoArray[0];delete t.ssrcInfoMap[a.ssrc],a.ssrc=this.sdpData.bigVideoSSRC,t.ssrcInfoMap[a.ssrc]=a}}else for(var i in t.ssrcInfoArray){var a=t.ssrcInfoArray[i];""!=this.smallStreamId&&-1!=a.msid.indexOf(this.smallStreamId)?(delete t.ssrcInfoMap[a.ssrc],a.ssrc=this.sdpData.smallVideoSSRC,t.ssrcInfoMap[a.ssrc]=a):""!=this.bigStreamId&&-1!=a.msid.indexOf(this.bigStreamId)&&(delete t.ssrcInfoMap[a.ssrc],a.ssrc=this.sdpData.bigVideoSSRC,t.ssrcInfoMap[a.ssrc]=a)}}},t.prototype.filterSdpObj=function(e){for(var i in e.mediaDesc){var t=e.mediaDesc[i];t.extmap={},t.ssrcGroup=[],t.codecInfoMap={};var a=[];for(var i in t.codecInfoArray){var r=t.codecInfoArray[i];"audio"==t.type?"opus"==r.codecName&&(a.push(r),t.codecInfoMap[r.payload]=r):"video"==t.type&&"H264"==r.codecName&&0==a.length&&(a.push(r),t.codecInfoMap[r.payload]=r)}t.codecInfoArray=a;var n={},s=[],o={};for(var i in t.ssrcInfoArray){var c=t.ssrcInfoArray[i];null==o[c.label]&&(o[c.label]=1,n[c.ssrc]=c,s.push(c))}t.ssrcInfoArray=s,t.ssrcInfoMap=n}},t.prototype.getSdpData=function(e,i){var t={audioSSRC:"",smallVideoSSRC:"",bigVideoSSRC:"",audioCodec:"0",videoCodec:"0",iceUfrag:"",icePwd:""};for(var a in t.iceUfrag=e.iceInfo.iceUfrag,t.icePwd=e.iceInfo.icePwd,e.mediaDesc){var r=e.mediaDesc[a];if(""==t.iceUfrag&&(t.iceUfrag=r.iceInfo.iceUfrag,t.icePwd=r.iceInfo.icePwd),"recvonly"!=r.commAbility)if("audio"==r.type){for(var n in r.ssrcInfoMap){var s=r.ssrcInfoMap[n];t.audioSSRC=s.ssrc}t.audioCodec=r.codecInfoArray[0].payload}else if("video"==r.type){for(var n in r.ssrcInfoMap){s=r.ssrcInfoMap[n];""!=i.bigStreamId&&(0==s.label.length?-1!=r.msid.indexOf(i.bigStreamId)&&(t.bigVideoSSRC=s.ssrc):-1!=s.label.indexOf(i.bigStreamId)&&(t.bigVideoSSRC=s.ssrc)),""!=i.smallStreamId&&(0==s.label.length?-1!=r.msid.indexOf(i.smallStreamId)&&(t.smallVideoSSRC=s.ssrc):-1!=s.label.indexOf(i.smallStreamId)&&(t.smallVideoSSRC=s.ssrc))}""==t.bigVideoSSRC&&""!=i.bigStreamId?0!=r.ssrcInfoArray.length&&(t.bigVideoSSRC=r.ssrcInfoArray[0].ssrc):""==t.smallVideoSSRC&&""!=i.smallStreamId&&0!=r.ssrcInfoArray.length&&(t.smallVideoSSRC=r.ssrcInfoArray[0].ssrc),t.videoCodec=r.codecInfoArray[0].payload}}return t},t.prototype.createDefaultVideoMediaSdpObj=function(e){e=e||102;var i=new MediaDesc;i.mid="video",i.type="video",i.rtcpResize=!0,i.fingerprintInfo.algorithm="sha-256",i.iceInfo.iceOptions="trickle";var t=new CodecInfo;return t.payload=e,t.codecName="H264",t.codecInterval="90000",t.fmtp=["level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42001f"],t.rtcpFB=["goog-remb","transport-cc","ccm fir","nack","nack pli"],i.codecInfoArray=[t],i.codecInfoMap[t.payload]=t,i},t.prototype.createDefaultAudioMediaSdpObj=function(e){e=e||111;var i=new MediaDesc;i.mid="audio",i.type="audio",i.fingerprintInfo.algorithm="sha-256",i.iceInfo.iceOptions="trickle";var t=new CodecInfo;return t.payload=e,t.codecName="opus",t.codecInterval="48000/2",t.fmtp=["minptime=10;useinbandfec=1"],t.rtcpFB=["transport-cc"],i.codecInfoArray=[t],i.codecInfoMap[t.payload]=t,i},t.prototype.createDefaultSdpObj=function(e,i){var t=new SdpDesc;return t.mediaDesc=[this.createDefaultAudioMediaSdpObj(i),this.createDefaultVideoMediaSdpObj(e)],t},t.prototype.createAnswerFromOfferUnifyPlan=function(e,i,t,a,r,n){""!=e.iceInfo.iceUfrag&&(e.iceInfo.iceUfrag=i),""!=e.iceInfo.icePwd&&(e.iceInfo.icePwd=t),e.iceInfo.iceLite=!0,""!=e.fingerprintInfo.algorithm&&(e.fingerprintInfo.value=a);var s=!1,o=!1,c=[];for(var d in e.mediaDesc){var l=e.mediaDesc[d];if(l.setup="actpass",l.iceInfo.iceUfrag=i,l.iceInfo.icePwd=t,l.iceInfo.iceLite=!0,""!=l.fingerprintInfo.algorithm&&(l.fingerprintInfo.value=a),l.candidate=n,l.ssrcInfoMap={},l.ssrcInfoArray=[],l.ssrcGroup=[],l.msid="","audio"!=l.type||s){if("video"==l.type&&!o)for(var f in o=!0,r){var p,m;if(0!=r[f].smallVideoSSRC)(p=sdpUtils.clone(l)).mid=l.type+"_s"+d+"_"+f,(m={}).ssrc=r[f].smallVideoSSRC,m.cname=r[f].cname,m.mslabel=r[f].streamId,m.label=this.uuid(),m.msid=m.mslabel+" "+m.label,p.ssrcInfoMap[m.ssrc]=m,p.ssrcInfoArray.push(m),p.msid=m.mslabel+" "+m.label,c.push(p);if(0!=r[f].bigVideoSSRC)(p=sdpUtils.clone(l)).mid=l.type+"_b"+d+"_"+f,(m={}).ssrc=r[f].bigVideoSSRC,m.cname=r[f].cname,m.mslabel=r[f].streamId,m.label=this.uuid(),m.msid=m.mslabel+" "+m.label,p.ssrcInfoMap[m.ssrc]=m,p.msid=m.mslabel+" "+m.label,p.ssrcInfoArray.push(m),c.push(p)}}else for(var f in s=!0,r){var u=sdpUtils.clone(l);u.mid=l.type+"_"+d+"_"+f;var h={};h.ssrc=r[f].audioSSRC,h.cname=r[f].cname,h.mslabel=r[f].streamId,h.label=this.uuid(),h.msid=h.mslabel+" "+h.label,u.ssrcInfoMap[h.ssrc]=h,u.ssrcInfoArray.push(h),u.msid=h.mslabel+" "+h.label,c.push(u)}}e.mediaDesc=c},t.prototype.createAnswerFromOfferUnifyPlan2=function(e,i,t,a,r,n){""!=e.iceInfo.iceUfrag&&(e.iceInfo.iceUfrag=i),""!=e.iceInfo.icePwd&&(e.iceInfo.icePwd=t),e.iceInfo.iceLite=!0,""!=e.fingerprintInfo.algorithm&&(e.fingerprintInfo.value=a);var s=0,o=0,c=0;for(var d in e.mediaDesc){var l=e.mediaDesc[d];if("actpass"==l.setup?l.setup="passive":l.setup="actpass",l.iceInfo.iceUfrag=i,l.iceInfo.icePwd=t,l.iceInfo.iceLite=!0,""!=l.fingerprintInfo.algorithm&&(l.fingerprintInfo.value=a),l.candidate=n,l.ssrcInfoMap={},l.ssrcInfoArray=[],l.ssrcGroup=[],l.msid="","recvonly"==l.commAbility){var f,p={};"audio"==l.type?(f=s,p.ssrc=r[f].audioSSRC,s++):"video"==l.type&&(o<c?(f=o,p.ssrc=r[f].bigVideoSSRC,o++):(f=c,p.ssrc=r[f].smallVideoSSRC,c++)),p.cname=r[f].cname,p.mslabel=r[f].streamId,p.label=this.uuid(),p.msid=p.mslabel+" "+p.label,l.ssrcInfoMap[p.ssrc]=p,l.ssrcInfoArray.push(p),l.msid=p.mslabel+" "+p.label,l.commAbility="sendonly"}}},t.prototype.createAnswerFromOfferPlanB=function(e,i,t,a,r,n){var s=this.createRandomString(u,16);""!=e.iceInfo.iceUfrag&&(e.iceInfo.iceUfrag=i),""!=e.iceInfo.icePwd&&(e.iceInfo.icePwd=t),e.iceInfo.iceLite=!0,""!=e.fingerprintInfo.algorithm&&(e.fingerprintInfo.value=a);var o=[],c=!1,d=!1;for(var l in e.mediaDesc){var f=e.mediaDesc[l];if(f.setup="actpass",f.iceInfo.iceUfrag=i,f.iceInfo.icePwd=t,f.iceInfo.iceLite=!0,""!=f.fingerprintInfo.algorithm&&(f.fingerprintInfo.value=a),f.candidate=n,f.ssrcInfoMap={},f.ssrcInfoArray=[],f.ssrcGroup=[],f.msid="","audio"!=f.type||c){if("video"==f.type&&!d){for(var l in d=!0,r){var p;if(0!=r[l].smallVideoSSRC)(p={}).ssrc=r[l].smallVideoSSRC,p.cname=s,p.mslabel=r[l].streamId,p.label=this.uuid(),p.msid=p.mslabel+" "+p.label,f.ssrcInfoMap[p.ssrc]=p,f.ssrcInfoArray.push(p);if(0!=r[l].bigVideoSSRC)(p={}).ssrc=r[l].bigVideoSSRC,p.cname=s,p.mslabel=r[l].streamId,p.label=this.uuid(),p.msid=p.mslabel+" "+p.label,f.ssrcInfoMap[p.ssrc]=p,f.ssrcInfoArray.push(p)}o.push(f)}}else{for(var l in c=!0,r){var m={};m.ssrc=r[l].audioSSRC,m.cname=s,m.mslabel=r[l].streamId,m.label=this.uuid(),m.msid=m.mslabel+" "+m.label,f.ssrcInfoMap[m.ssrc]=m,f.ssrcInfoArray.push(m)}o.push(f)}}e.mediaDesc=o},t.prototype.addTransceiverForOffer=function(e,i){for(var t in i)e.addTransceiver("audio",{direction:"recvonly"}),e.addTransceiver("video",{direction:"recvonly"}),e.addTransceiver("video",{direction:"recvonly"})},t.prototype.sendOffers=function(){if(null==this.localMediaStream&&"controlled"==m.iceControlRole)return this.sdpData={audioSSRC:"",smallVideoSSRC:"",bigVideoSSRC:"",audioCodec:"0",videoCodec:"0",iceUfrag:this.createRandomString(o,4),icePwd:this.createRandomString(o,24)},void this.callback({type:"createOffer",status:"success",audioSSRC:this.sdpData.audioSSRC,smallVideoSSRC:this.sdpData.smallVideoSSRC,bigVideoSSRC:this.sdpData.bigVideoSSRC,videoCodec:this.sdpData.videoCodec,audioCodec:this.sdpData.audioCodec,iceUfrag:this.sdpData.iceUfrag,icePwd:this.sdpData.icePwd});var e,r,n,s=this;"controlled"==m.iceControlRole?e=this.tempPC:(e=this.starPeerConnection,"unified-plan"==m.sdpSemantics&&this.addTransceiverForOffer(e,this.streamInfos)),e.createOffer((r=e,n=this.callback,function(e){var i=sdpUtils.parseSdp(e.sdp);s.filterSdpObj(i);var t=sdpUtils.genSdp(i);s.offerSDP=i,e.sdp=t;var a=s.getSdpData(i,{bigStreamId:s.bigStreamId,smallStreamId:s.smallStreamId});s.sdpData=a,"controlled"==m.iceControlRole?(s.tempPC.close(),delete s.tempPC,s.tempPC=null,n({type:"createOffer",status:"success",audioSSRC:a.audioSSRC,smallVideoSSRC:a.smallVideoSSRC,bigVideoSSRC:a.bigVideoSSRC,videoCodec:a.videoCodec,audioCodec:a.audioCodec,iceUfrag:a.iceUfrag,icePwd:a.icePwd})):r.setLocalDescription(e).then(function(){n({type:"createOffer",status:"success",audioSSRC:a.audioSSRC,smallVideoSSRC:a.smallVideoSSRC,bigVideoSSRC:a.bigVideoSSRC,videoCodec:a.videoCodec,audioCodec:a.audioCodec,iceUfrag:a.iceUfrag,icePwd:a.icePwd})},function(e){n({type:"createOffer",status:"failed",audioSSRC:a.audioSSRC,smallVideoSSRC:a.smallVideoSSRC,bigVideoSSRC:a.bigVideoSSRC,videoCodec:a.videoCodec,audioCodec:a.audioCodec,iceUfrag:a.iceUfrag,icePwd:a.icePwd})})}),function(e){console.error(e),s.callback({type:"createOffer",status:"failed"})})},t.prototype.receiveOffer=function(e,i){this.starPeerConnection;this.sendAnswer(e,i)},t.prototype.sendAnswer=function(i,e){var t=this.starPeerConnection,a=this;t.setRemoteDescription(new r(e)),t.createAnswer(function(e){t.setLocalDescription(e),a.socket.send(JSON.stringify({eventName:"__answer",data:{socketId:i,sdp:e}}))},function(e){console.error(e)})},t.prototype.receiveAnswer=function(e,i){var t=this.starPeerConnection,a=this;t.setRemoteDescription(new r(i)).then(function(){a.callback({type:"applyAnswer",status:"success"})},function(e){a.callback({type:"applyAnswer",status:"failed"})})},t.prototype.createPeerConnections=function(){this.createPeerConnection("xuaisi")},t.prototype.createPeerConnection=function(e){var a=this,r=new n(m);return this.starPeerConnection&&(this.closePeerConnection(this.starPeerConnection),delete this.starPeerConnection,this.starPeerConnection=null),this.tempPC&&(this.closePeerConnection(this.tempPC),delete this.tempPC,this.tempPC=null),this.starPeerConnection=r,null!=this.localMediaStream&&"controlled"==m.iceControlRole&&(this.tempPC=new n(m)),r.onicecandidate=function(e){},r.oniceconnectionstatechange=function(e){if(console.log("oniceconnectionstatechange:"+r.iceConnectionState),"connected"===r.iceConnectionState&&null!=a.streamAllSetCallback){var i=!0;for(var t in a.streamInfos){null==a.streamInfos[t].streamObj&&(i=!1)}i&&(a.streamAllSetCallback(),a.streamAllSetCallback=null)}},r.onconnectionstatechange=function(e){if(console.log("onconnectionstatechange:"+r.connectionState),"connected"===r.connectionState&&null!=a.streamAllSetCallback){var i=!0;for(var t in a.streamInfos){null==a.streamInfos[t].streamObj&&(i=!1)}i&&(a.streamAllSetCallback(),a.streamAllSetCallback=null)}},r.onopen=function(){console.log("pc onopen")},r.onaddstream=function(e){a.onAddStream(e.stream)},r.ondatachannel=function(e){},r},t.prototype.closePeerConnection=function(e){e&&e.close()},t.prototype.broadcast=function(e){var i;for(i in this.dataChannels)this.sendMessage(e,i)},t.prototype.sendMessage=function(e,i){"open"===this.dataChannels[i].readyState.toLowerCase()&&this.dataChannels[i].send(JSON.stringify({type:"__msg",data:e}))},t.prototype.addDataChannels=function(){var e;for(e in this.peerConnections)this.createDataChannel(e)},t.prototype.createDataChannel=function(i,e){var t,a;t=this.peerConnections[i],i||this.emit("data_channel_create_error",i,new Error("attempt to create data channel without socket id")),t instanceof n||this.emit("data_channel_create_error",i,new Error("attempt to create data channel without peerConnection"));try{a=t.createDataChannel(e)}catch(e){this.emit("data_channel_create_error",i,e)}return this.addDataChannel(i,a)},t.prototype.addDataChannel=function(t,a){var r=this;return a.onopen=function(){r.emit("data_channel_opened",a,t)},a.onclose=function(e){delete r.dataChannels[t],r.emit("data_channel_closed",a,t)},a.onmessage=function(e){var i;"__file"===(i=JSON.parse(e.data)).type?r.parseFilePacket(i,t):r.emit("data_channel_message",a,t,i.data)},a.onerror=function(e){r.emit("data_channel_error",a,t,e)},this.dataChannels[t]=a},new t};